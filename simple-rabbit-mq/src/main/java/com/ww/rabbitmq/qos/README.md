## Channel Prefetch Setting (QoS) 信道预取设置(QoS)

由于消息是异步发送(推送)
到客户端的，因此在任何给定时刻，通道上通常都有多个“正在传输”的消息。此外，来自客户端的手动确认本质上也是异步的。因此，有一个未确认的送货标签的
滑动窗口。开发人员通常倾向于限制此窗口的大小，以避免消费者端的无限缓冲区问题。这是通过使用basic.qos方法设置“预取计数”值来实现的。该值定义通道
上允许的未确认传递的最大数量。一旦数量达到配置的计数，RabbitMQ将停止在通道上传递更多消息，除非至少确认其中一个未完成的消息。(值0被视为无限，
允许任意数量的未确认消息。)

例如，假设在通道CH上存在未确认的递送标签5、6、7和8，并且通道CH的预取计数被设置为4，则RabbitMQ将不会在CH上推送任何更多的递送，除非至少有一个
未完成的递送被确认。当确认帧到达该信道且Delivery_Tag设置为5(或6、7或8)时，RabbitMQ 将通知并传递另一条消息。同时确认多个消息将使多个消息可用于传递。

值得重申的是，交付流和手动客户端确认流完全是异步的。因此，如果在已有传送在传输中时更改预取值，则会出现自然争用情况，并且通道上可能暂时存在多于预取计数的未确认消息。

可以为特定通道或特定使用者配置 QoS 设置。

确认模式和QoS预取值对消费者吞吐量有显著影响。一般来说，增加预取会提高消息传递给消费者的速率。自动确认模式可产生最佳可能的传输速率。但是，在这
两种情况下，已传递但尚未处理的消息数量也会增加，从而增加消费者RAM消耗。

应谨慎使用无限制预取的自动确认模式或手动确认模式。在没有确认的情况下消费大量消息的消费者将导致其连接的节点上的内存消耗增长。寻找合适的预取值需要
反复尝试，并且会因工作负载的不同而有所不同。在100到300范围内的值通常提供最佳吞吐量，并且不会有让消费者不堪重负的重大风险。较高的价值往往会遇到
回报递减的规律。

预取值为1是最保守的。它将显著降低吞吐量，特别是在消费者连接延迟较高的环境中。对于许多应用程序，较高的值将是合适和最佳的。

